name: Nightly Build
on: 
  schedule: 
    - cron: 0 0 * * *
  workflow_dispatch:
jobs:
  main:
    name: Fetch The Lastet V2ray Source Code,Modify,And Build
    runs-on: ubuntu-18.04
    steps: 
    - name: PrepareGoEnv
      run: |
        sudo apt install -y wget git
        wget -q https://golang.google.cn/dl/go1.19.5.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.19.5.linux-amd64.tar.gz
        /usr/local/go/bin/go version
    - name: PrepareGit
      run: |
        sudo echo 'StrictHostKeyChecking no' > ~/.ssh/config
        git config --global user.email "shadowobject@protonmail.com"
        git config --global user.name "ShadowObj"
        echo -e ${{secrets.SSH_PRIKEY}} > ~/.ssh/id_rsa
    - name: Fetch,Modify,Build
      run: |
        git clone https://github.com/v2fly/v2ray-core.git
        cd v2ray-core/main
        rm ./main.go
        wget -q https://github.com/ShadowObj/v2plusGoorm/raw/main/main.go
        sudo /usr/local/go/bin/go build
        cd ../../
        tar -zcvf v2ray-core-source.tar.gz ./v2ray-core
        git clone https://github.com/ShadowObj/v2plusGoorm.git
        cd v2plusGoorm && git init
        mv ../v2ray-core/main/main ./
        mv ../v2ray-core-source.tar.gz ./
        git add .
        git commit -m "Nightly Build By Github Actions"
        git remote set-url origin https://github.com/ShadowObj/v2plusGoorm.git 
        git push -u origin main
